## 重新发现PG之美 - 系列视频    
    
### 作者    
digoal    
    
### 日期    
2021-05-26     
    
### 标签    
PostgreSQL , PG 之美    
    
----    
    
## 背景    
#### 1、重新发现PG之美 - 1 预测类应用    
使用PG的统计学聚合函数, 结合统计学的线形回归知识, 可以用来实现股价、用户行为、天气等数据的预测.    
PG不仅支持简单的一元回归, 还能通过madlib, plR等实现多元、多重回归模型.    
    
视频回放:  https://www.bilibili.com/video/BV1mA411g7XJ/    
    
#### 2、重新发现PG之美 - 2 exclude 排他!    
exclude排他约束是PG的独特约束, 属于动态约束, 通过GiST索引实现, 采用对等操作符进行检查.    
例如会议室预定系统:    
避免会议室时间相交的异常问题、    
避免行政区块存储多边形相交的问题、    
排除品类系统中一个物品被误入多个品类的问题.    
    
视频回放:  https://www.bilibili.com/video/BV1ho4y11731/    
    
#### 3、重新发现PG之美 - 3 range 200x!    
解决全球化部署、多中心业务根据来源IP智能路由到就近机房的智能DNS性能问题, 200倍提升不是梦.    
PG 支持了Range类型, 一个字段可以存储传统数据库2个字段才能存储的数据, 同时比2个字段的between and用法性能提升200倍.    
原因是PG采用了range gist索引, 比btree的大范围链表扫描采用了更有效的访问路径, 二维收敛, 访问block急剧减少, 性能爆炸式提升.    
    
视频回放:  https://www.bilibili.com/video/BV13q4y1j7Ta/    
    
#### 4、重新发现PG之美 - 4 随机漫步踏浪而来  
在一些论坛、短视频业务中, 编辑精选和地域或大范围精选的内容会采用随机推荐的方式推送给客户.  
随机查询就有了高并发、低延迟的需求, 然而通用的order by random()随机方法性能太烂, 无法满足需求.  
PG 提供了tablesample method(para)方法, 能够以几千倍的性能满足高并发需求.  
    
视频回放:  https://www.bilibili.com/video/BV1cy4y137WU/  
  
#### 5、重新发现PG之美 - 5 在不确定的世界寻找答案  
经典物理的世界, 似乎一切都是可预测的, 而量子理论告诉我们, 世界充满不确定性:    
股票哪个会涨?   
房价会不会跌?   
美元还会继续贬值吗?   
哪些是我的意向客户?    
你有多大的概率会下单?    
  
然而现在的经典数据库只能给我们确定的答案, ```=, >, <, >=, <=, @>, @@, ||, &, !, ......  ``` , 怎么办?   
  
PG 向量检索+近似库datasketch, 在不确定世界寻找答案!    
  
视频回放:  https://www.bilibili.com/video/BV12Q4y1R771/  
   
#### 6、重新发现PostgreSQL之美 - 6 index链表跳跳糖
CTE 递归语法是PG 8.4引入的功能, 至今已经10多年, 非常文档.  
CTE 递归可以解决很多问题: 时序场景取所有传感器最新的value, 图式数据的搜索(一度人脉,N度人脉,最近的路径关系), 树状数据的累加分析, 知识图谱, 去稀疏数据的唯一值等.  
使用CTE递归比通用的方法通常有数百倍的性能提升.  
    
https://www.bilibili.com/video/BV18K4y1R7fb/
  
#### 7、重新发现PostgreSQL之美 - 7 垂帘听政 异步消息
场景:
- 重要数据在写入、更新、删除时 实时告警或转存
- 流式数据 (公务车电子围栏、刑侦数据探针、股票数据规则探针、服务器运行情况) 实时预警或事件触发
- 危险操作 (DDL) 异步监控

规则 + 异步消息的优势:
1、通过规则过滤掉不需要写入的正常数据, 由于业务正常数据通常占比在99%以上, 从而大幅减轻写入量.
2、传统的利用定时器查询所有数据去发现问题, 还需要在时间、VAL、SID等层面去建立索引, 消耗大量存储, 同时索引增加写入RT, 性能下降. 规则+异步完全规避这个问题.
3、可以实时发现并预警或触发其他动作
  
视频回放:  https://www.bilibili.com/video/BV1Nq4y1j79T/
  
#### 8、重新发现PostgreSQL之美 - 8 轨迹业务IO杀手克星index include(覆盖索引) 
场景痛点:
- 轨迹类业务, 一个轨迹由多个点组成, 每个点的ROW写入散落到不同的PAGE, 查询一条轨迹可能要回表访问上百千个PAGE, 号称IO杀手.

业务:
- 共享单车、巡逻车、公务用车、网约车、金融行业股票数据、物联网行业传感器数据等.

PG index include (覆盖索引)功能:
- 重组存储结构, 按指定维度聚集.
- 叶子结点存储include column value, 无需回表(轨迹数据都是append only的, VM bit全部都是clean page, 因此无需回表).
  
视频回放: https://www.bilibili.com/video/BV1tV41177rY/    
  
#### 9、重新发现PostgreSQL之美 - 9 面向多值列的倒排索引 GIN|RUM
场景:    
通用业务, 分词查询诉求.    
    
挑战:    
传统数据库没有分词、实时全文检索索引功能, 需要将数据同步到搜索引擎, 这种解决方案的弊端:     
- 研发成本增加、    
- 软硬件成本增加、    
- 系统问题增多(同步延迟问题、同步异常问题、同步一致性问题)、    
- 开发灵活性下降(无法同时过滤分词条件与表的其他条件, 需要业务层交换数据)    
- 同时过滤分词条件与表的其他条件后, 无法有效的按RANK排序分词相似性    
    
PG 解决方案:    
- 1、倒排索引GIN:     
    - 支持多值类型的按元素检索: tsvector, array, json, xml, hstore, 任意字段组合搜索       
    - 一对多的数据模型      
- 2、增强倒排索引RUM, RANK 加速方案:     
    - RUM索引在posting list里面, 每个行号后面附加addon内容(文本向量的对应位置信息), 同时支持自定义addon信息.     
    - addon的内容优势: 不需要回表搜索tuple内容. 降低IO, 提高性能.    
  
视频回放: https://www.bilibili.com/video/BV1CA411g7oK/       
  
#### 10、重新发现PostgreSQL之美 - 10 内卷 & 大禹治水
场景:   
内卷现象, 供不应求(高峰期打车、电商秒杀), 热点数据更新    
社会现象: 资源有限而需求无限的情况(春运时期的火车票、学生报补习班、企业里面的资源地盘争夺等)   
  
挑战:   
当系统中出现热点row时, 意味着大量的并发请求更新同一行数据, 因为数据库最小粒度的锁为行锁, 所以这些并发请求只能串行执行,    
一个会话在更新的时候其他所有会话都处于等待状态, 可能导致连接打爆, 其他会话连不进来引起雪崩.     
如果被秒杀的商品库存只有10个, 那么实际上只有10个请求能达成交易, 其他等待中的会话都属于无用功. 浪费大量的连接和等待时间.    
  
PG 解决方案:   
大禹治水(疏导、消灭无用等待):   
- SKIP LOCKED,   
- advisory lock    
  
视频回放: https://www.bilibili.com/video/BV1cg411G7rx/  
  
#### 11、重新发现PostgreSQL之美 - 11 时空轨迹系统 新冠&刑侦&预测  
1、时空轨迹的业务场景:   
  
疫情防控:   
- 根据病毒携带者的轨迹快速找到密切接触者. 轨迹距离计算   
    - 1度、2度、N度接触者    
  
公安刑侦:   
- 同行人分析: 轨迹相似度   
- 密切接触分析: 轨迹距离   
  
预测:   
- 根据轨迹数据建模, 预测群体事件、时空数据热点分布等, 用于智慧城市管理、智慧交通等.   
- 与商业结合, 时空轨迹+用户画像.   
  
2、业务挑战:    
数据量大, 数据与业务割裂, 计算纯靠coding实现, 开发效率低下, 运行效率良莠不齐.    
  
3、对时序数据库系统的诉求:  
写入吞吐要求高, 延迟低, 查询要求响应快, 压缩比要求高(节省存储成本), 算法的扩展能力要求强.   
  
  
4、PG解决方案:   
- 轨迹类型:   
    - geometry  
- 轨迹分析函数:    
    - 最近距离计算   
    - 相似度计算  
    - 相遇时间计算  
    - 相遇可能性判断  
    - 轨迹有效性判断  
- 压缩能力  
- sharding 能力(citus, timescaledb, ymatrix, POLARDB 等)   
  
```  
ST_IsValidTrajectory — Returns true if the geometry is a valid trajectory.  
ST_ClosestPointOfApproach — Returns the measure at which points interpolated along two trajectories are closest.  
ST_DistanceCPA — Returns the distance between the closest point of approach of two trajectories.  
ST_CPAWithin — Returns true if the closest point of approach of two trajectories is within the specified distance.  
```  
  
节点内并行 (PG parallel scan, since PG 9.6)     
多节点并行 (fdw async append, since PG 14)     
  
  
5、阿里云 PG Ganos 支持更加丰富的轨迹计算:   
- 轨迹压缩  
- 空间关系判断  
- 空间处理  
- 空间统计  
- 时空关系判断  
- 时空处理  
- 时空统计  
- 距离测量  
- 相似度分析  
  
直播回放: https://www.bilibili.com/video/BV1eV411x7KW/  
  
#### 12、重新发现PostgreSQL之美 - 12 SaaS & 多租户 捣蛋鬼,你揍开  

场景:
- 游戏、SaaS行业.  serverless 场景: 在一个企业内部, 业务线非常多,
- 在同一个实例中有多个业务共同使用时,
- 分析师、DBA或者运营人员有偶尔使用数据库的需求.

挑战:
- 为每个业务分配一个数据库实例存在的问题: 资源浪费(每个实例在内存、空间方面的浪费)、弹性较差(创建资源慢、扩容缩容慢).
- 多个业务共享一个实例存在的问题: 资源争抢、干扰、抖动、安全风险增加,
- DBA或分析师人为的大查询可能将资源耗光, 影响在线业务

PG 方案:
- 按来源IP、USER、DBNAME、application_name等信息来区分用户和业务
- 结合cgroup隔离业务的cpu、io、网络等资源使用率, 防止干扰
    
视频回放: https://www.bilibili.com/video/BV1SQ4y1X7oC/  
    
#### 13、重新发现PostgreSQL之美 - 13 brin 时序索引
场景:
- 物联网、游戏、金融、证券、车联网等场景, appendonly的高并发数据写入, 需要高效的按时间区间进行数据统计分析.

挑战:
- 写入量大, 传统btree索引对写入的RT影响大, 导致性能下降严重.
- 普通btree索引存储空间占用较大.
- 普通btree索引采用链表存储, 逻辑上有序, 而物理离散, 加上IO有prefetch, 使得按btree的索引范围查询将占用大量IO通道. 范围查询效率差.

PG解决方案:
- PG采用堆表存储, 使用时序索引, 每连续的N个数据块存储min,max val.  时序索引只有btree的几百分之一大小. 并且支持快速的范围查询.
- 其他数据库产品采用聚集存储无法实现时序索引, 因为聚集存储本身必须按PK组织, 在数据块层面已经没有时序顺序了.

视频回放:  https://www.bilibili.com/video/BV1B64y1k72g/  
  
#### 14、重新发现PostgreSQL之美 - 14 bloom 布隆过滤器索引
场景:      
分析业务, 任意字段、任意维度组合, 组合等值查询.    
where a=? and b=? or c=? . 其他组合 ab ac ad bc bd bcd bdef def ... 每个字母代表一个字段.  
在电商、金融等拖拽式实时分析场景中尤为常见.   
  
挑战:   
由于查询维度非常多, 完全不可控, 如果每个维度都预计算, 会导致结果数据量指数级增加.   
如果为每个查询维度都创建一个索引, 那么会有N!+1个索引. 例如5个字段的任意组合有121种, 需要建121个索引, 完全不现实.   
  
PG 解决方案:  
使用bloom布隆过滤索引. 每个value被hash计算后映射到若干个bit位, 这些bit位被设置为1表示包含这个value.   
一个索引即可满足任意维度的组合等值搜索.      
  
视频回放:  https://www.bilibili.com/video/BV1c64y1C7HK/        
  
#### 15、重新发现PostgreSQL之美 - 15 沙盘推演, 权力的游戏
  
有数据说数据, 没数据说案例, 没案例说逻辑, 没逻辑谈理想. 已经成为数字时代的职场生存法则.
- 要陈述一个观点或结论, 没有数据支撑说话没分量, 说明你没经过仔细分析, 没过脑子.
- 实在拿不到数据, 你总得拿点案例出来, 否则就是在空谈, 没有支点.
- 没案例, 总得有底层逻辑吧, 逻辑能自洽, 也是说得通的.
- 如果连逻辑都没有想过, 那你只能用故事、理想或者理念来感染人, 如果你能忽悠(感染)成功, 并且最后确实也成功了, 也许能表达为因为相信所以看见.

场景:
- 项目上线前, 申请资源, 如何评估需要多少资源?
- 做IT部门的全年预算?
- 如何做到精准, 有理有据有节?

挑战:
- 项目往往只有业务指标(应该叫目标, 和IT预算精算还差了十万八千里), 靠经验或拍脑袋来确定IT预算, 上线后发现资源不足或严重超过预期, 造成铺张浪费.
- 难以模拟和快速产生真实的业务数据.
- 难以模拟真实的业务交互行为.
- 难以捕捉和分析性能问题的原因.

PG解决方案:
- pgbench, 支持沙盘推演, 避免纸上谈兵、假大空.
    - 一个可以近乎真实的模拟业务上线后的压力的内置benchmark program.
    - 内置多种数据生成算法, 多种模拟业务和数据库交互的command,
    - 同时支持根据业务定制化压测程序, 模拟真实的业务交互行为.
- awr, pg_stat_statements, 捕获和分析业务瓶颈
    - ##### 202104/20210415_01.md   [《PostgreSQL pg_stat_statements AWR 插件 pg_stat_monitor , 过去任何时间段性能分析 [推荐、收藏]》](../202104/20210415_01.md)
    - ##### 202003/20200324_25.md   [《PostgreSQL 活跃会话历史记录插件 - pgsentinel 类似performance insight \ Oracle ASH Active Session History》](../202003/20200324_25.md)
    - ##### 201901/20190125_02.md   [《PostgreSQL Oracle 兼容性之 - performance insight - AWS performance insight 理念与实现解读 - 珍藏级》](../201901/20190125_02.md)
    - https://www.postgresql.org/docs/devel/pgstatstatements.html
- 快速构建海量测试数据
    - ##### 202001/20200103_01.md   [《PostgreSQL+MySQL 联合解决方案 - 第3课视频 - 如何压测PG数据库、如何瞬间构造海量测试数据》](../202001/20200103_01.md)
    - ##### 201711/20171121_01.md   [《PostgreSQL 如何快速构建 海量 逼真 测试数据》](../201711/20171121_01.md)

  
视频回放: https://www.bilibili.com/video/BV1Zq4y1j7xs/  
  
    
#### [PostgreSQL 许愿链接](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")  
您的愿望将传达给PG kernel hacker、数据库厂商等, 帮助提高数据库产品质量和功能, 说不定下一个PG版本就有您提出的功能点. 针对非常好的提议，奖励限量版PG文化衫、纪念品、贴纸、PG热门书籍等，奖品丰富，快来许愿。[开不开森](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216").    
    
    
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")  
    
    
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")  
    
    
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")  
    
    
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")  
    
    
